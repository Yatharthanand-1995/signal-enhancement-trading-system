<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading System Performance Dashboard</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #4ECDC4;
            margin: 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }
        .status-healthy { background-color: #2ECC71; }
        .status-warning { background-color: #F39C12; }
        .status-critical { background-color: #E74C3C; }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background-color: #2c2c2c;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .metric-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-unit {
            font-size: 14px;
            color: #888;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        .chart-container {
            background-color: #2c2c2c;
            border-radius: 8px;
            padding: 20px;
        }
        .refresh-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4ECDC4;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
        }
        .refresh-btn:hover {
            background-color: #45B7D1;
        }
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #2c2c2c;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>Trading System Performance Dashboard</h1>
            <span id="health-status">System Status: <span class="status-indicator status-healthy" id="status-indicator"></span></span>
            <div style="margin-top: 10px; color: #888;" id="last-update">Last Update: --</div>
        </div>

        <button class="refresh-btn" onclick="requestRefresh()">Refresh</button>

        <div class="metrics-grid" id="metrics-grid">
            <!-- Metrics will be populated by JavaScript -->
        </div>

        <div class="charts-grid" id="charts-grid">
            <!-- Charts will be populated by JavaScript -->
        </div>

        <div class="connection-status" id="connection-status">
            <span class="status-indicator status-critical" id="connection-indicator"></span>
            Connecting...
        </div>
    </div>

    <script>
        const socket = io();
        let isConnected = false;

        socket.on('connect', function() {
            isConnected = true;
            updateConnectionStatus('Connected', 'healthy');
        });

        socket.on('disconnect', function() {
            isConnected = false;
            updateConnectionStatus('Disconnected', 'critical');
        });

        socket.on('initial_data', function(data) {
            updateMetrics(data.metrics);
            updateCharts(data.charts);
        });

        socket.on('metrics_update', function(data) {
            updateMetrics(data.metrics);
        });

        socket.on('refresh_data', function(data) {
            updateMetrics(data.metrics);
            updateCharts(data.charts);
        });

        function updateConnectionStatus(status, level) {
            document.getElementById('connection-status').innerHTML = 
                `<span class="status-indicator status-${level}" id="connection-indicator"></span> ${status}`;
        }

        function updateMetrics(metrics) {
            const metricsGrid = document.getElementById('metrics-grid');
            const lastUpdate = document.getElementById('last-update');
            
            lastUpdate.textContent = `Last Update: ${new Date(metrics.timestamp).toLocaleString()}`;
            
            // Update health status
            const healthStatus = metrics.database.healthy && metrics.cache.redis_connected ? 'healthy' : 'warning';
            document.getElementById('status-indicator').className = `status-indicator status-${healthStatus}`;
            
            const metricsHtml = `
                <div class="metric-card">
                    <div class="metric-title">CPU Usage</div>
                    <div class="metric-value" style="color: ${metrics.system.cpu_percent > 80 ? '#E74C3C' : '#4ECDC4'}">${metrics.system.cpu_percent.toFixed(1)}</div>
                    <div class="metric-unit">%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Memory Usage</div>
                    <div class="metric-value" style="color: ${metrics.system.memory_percent > 85 ? '#E74C3C' : '#4ECDC4'}">${metrics.system.memory_percent.toFixed(1)}</div>
                    <div class="metric-unit">%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Database Health</div>
                    <div class="metric-value" style="color: ${metrics.database.healthy ? '#2ECC71' : '#E74C3C'}">${metrics.database.healthy ? 'Healthy' : 'Down'}</div>
                    <div class="metric-unit">${metrics.database.response_time.toFixed(3)}s response</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Cache Hit Rate</div>
                    <div class="metric-value" style="color: ${metrics.cache.hit_rate > 80 ? '#2ECC71' : '#F39C12'}">${metrics.cache.hit_rate.toFixed(1)}</div>
                    <div class="metric-unit">%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">API Response Time</div>
                    <div class="metric-value">${(metrics.api.avg_response_time * 1000).toFixed(1)}</div>
                    <div class="metric-unit">ms</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Real-time Events</div>
                    <div class="metric-value">${metrics.realtime.messages_per_second.toFixed(1)}</div>
                    <div class="metric-unit">events/sec</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Active Streams</div>
                    <div class="metric-value">${metrics.realtime.active_streams}</div>
                    <div class="metric-unit">streams</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">WebSocket Clients</div>
                    <div class="metric-value">${metrics.realtime.websocket_connections}</div>
                    <div class="metric-unit">connections</div>
                </div>
            `;
            
            metricsGrid.innerHTML = metricsHtml;
        }

        function updateCharts(charts) {
            const chartsGrid = document.getElementById('charts-grid');
            chartsGrid.innerHTML = '';
            
            Object.keys(charts).forEach(chartId => {
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-container';
                chartDiv.id = chartId;
                chartsGrid.appendChild(chartDiv);
                
                const chart = charts[chartId];
                chart.layout.plot_bgcolor = '#2c2c2c';
                chart.layout.paper_bgcolor = '#2c2c2c';
                chart.layout.font = {color: '#ffffff'};
                
                Plotly.newPlot(chartId, chart.data, chart.layout, {responsive: true});
            });
        }

        function requestRefresh() {
            if (isConnected) {
                socket.emit('request_refresh');
            }
        }

        // Auto-refresh charts every 30 seconds
        setInterval(() => {
            if (isConnected) {
                socket.emit('request_refresh');
            }
        }, 30000);
    </script>
</body>
</html>